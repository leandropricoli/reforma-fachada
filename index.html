<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Controle de Reforma da Fachada">
    <title>Controle de Reforma da Fachada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @media (max-width: 768px) {
            .container {
                width: 100%;
                padding: 0 10px;
            }
            
            .status-badges {
                font-size: 0.7rem;
                padding: 0.25rem 0.5rem;
            }
        }
        
        .status-btn {
            transition: all 0.3s ease;
        }
        
        .locked {
            filter: brightness(0.8);
            pointer-events: none;
        }
        
        textarea {
            resize: none;
        }
        
        .whatsapp-icon {
            color: #25D366;
        }
        
        .block-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .block-header {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 400px;
            width: 90%;
        }
        
        .timestamp {
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.25rem;
            text-align: center;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }
        
        .status-summary {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .status-badges {
            font-weight: bold;
            padding: 0.3rem 0.6rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
        }
        
        .progress-container {
            width: 100%;
            height: 30px;
            background-color: #e5e7eb;
            border-radius: 15px;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #10b981;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            min-width: 50px;
        }
        
        .progress-text {
            color: #000;
            font-weight: bold;
            font-size: 0.9rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <header class="mb-8">
            <h1 class="text-2xl font-bold text-center text-blue-800 mb-4">Controle de Reforma da Fachada</h1>
            
            <!-- Progress bar -->
            <div class="progress-container">
                <div class="progress-bar" id="progressBar" style="width: 0%">
                    <span class="progress-text" id="progressText">0%</span>
                </div>
            </div>
            
            <!-- Action buttons (Lock and Clear) -->
            <div class="action-buttons justify-center">
                <div class="flex flex-col items-center">
                    <button id="lockBtn" class="bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center mb-1">
                        <i class="fas fa-lock-open mr-2"></i> Bloquear
                    </button>
                    <div id="lockTimestamp" class="timestamp"></div>
                </div>
                <button id="clearBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg flex items-center h-fit">
                    <i class="fas fa-trash-alt mr-2"></i> Limpar Tudo
                </button>
            </div>
            
            <!-- Status summary badges -->
            <div class="status-summary">
                <span class="status-badges bg-red-500 text-white">
                    <i class="fas fa-times-circle mr-1"></i>
                    Não iniciado: <span id="notStartedCount">0</span>
                </span>
                <span class="status-badges bg-yellow-500 text-white">
                    <i class="fas fa-spinner mr-1"></i>
                    Em andamento: <span id="inProgressCount">0</span>
                </span>
                <span class="status-badges bg-green-500 text-white">
                    <i class="fas fa-check-circle mr-1"></i>
                    Finalizado: <span id="completedCount">0</span>
                </span>
            </div>
        </header>

        <main id="appContainer" class="block-container">
            <!-- Blocks will be generated here -->
        </main>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Confirmar Limpeza</h3>
            <p class="mb-6">Tem certeza que deseja limpar todos os dados? Esta ação não pode ser desfeita.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancelClear" class="bg-gray-300 text-gray-800 px-4 py-2 rounded">Cancelar</button>
                <button id="confirmClear" class="bg-red-600 text-white px-4 py-2 rounded">Limpar Tudo</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD8U2j4Xv5p0QJv5X9X5X9X5X9X5X9X5X9X",
            authDomain: "reference-479c7.firebaseapp.com",
            databaseURL: "https://reference-479c7-default-rtdb.firebaseio.com",
            projectId: "reference-479c7",
            storageBucket: "reference-479c7.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:5X9X5X9X5X9X5X9X5X9X5X"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // App state
        let isLocked = false;
        let statusCounts = {
            notStarted: 0,
            inProgress: 0,
            completed: 0
        };
        
        // Generate blocks grouped by final (1-6)
        const blocks = [
            { 
                name: "FINAL 1", 
                items: [11, 21, 31, 41, 51, 61, 71, 81, 91, 101, 111, 121, 131, 141, 151, 161, 171, 181, 191, 201, 211, 221] 
            },
            { 
                name: "FINAL 2", 
                items: [12, 22, 32, 42, 52, 62, 72, 82, 92, 102, 112, 122, 132, 142, 152, 162, 172, 182, 192, 202, 212, 222] 
            },
            { 
                name: "FINAL 3", 
                items: [13, 23, 33, 43, 53, 63, 73, 83, 93, 103, 113, 123, 133, 143, 153, 163, 173, 183, 193, 203, 213, 223] 
            },
            { 
                name: "FINAL 4", 
                items: [14, 24, 34, 44, 54, 64, 74, 84, 94, 104, 114, 124, 134, 144, 154, 164, 174, 184, 194, 204, 214, 224] 
            },
            { 
                name: "FINAL 5", 
                items: [15, 25, 35, 45, 55, 65, 75, 85, 95, 105, 115, 125, 135, 145, 155, 165, 175, 185, 195, 205, 215, 225] 
            },
            { 
                name: "FINAL 6", 
                items: [16, 26, 36, 46, 56, 66, 76, 86, 96, 106, 116, 126, 136, 146, 156, 166, 176, 186, 196, 206, 216, 226] 
            }
        ];
        
        // Generate HTML for blocks
        function generateBlocks() {
            const appContainer = document.getElementById('appContainer');
            appContainer.innerHTML = '';
            
            blocks.forEach(block => {
                const blockElement = document.createElement('div');
                blockElement.className = 'bg-white p-4 rounded-lg shadow';
                
                // Block header with name and status summary
                const blockHeader = document.createElement('div');
                blockHeader.className = 'block-header flex justify-between items-center mb-4 pb-2 border-b';
                
                const blockName = document.createElement('h2');
                blockName.className = 'font-bold text-lg';
                blockName.textContent = block.name;
                
                const blockStatus = document.createElement('div');
                blockStatus.className = 'flex space-x-1';
                blockStatus.innerHTML = `
                    <span class="status-badges bg-red-500 text-white">0</span>
                    <span class="status-badges bg-yellow-500 text-white">0</span>
                    <span class="status-badges bg-green-500 text-white">0</span>
                `;
                blockStatus.id = `status-${block.name.replace(' ', '-')}`;
                
                blockHeader.appendChild(blockName);
                blockHeader.appendChild(blockStatus);
                blockElement.appendChild(blockHeader);
                
                // Items in the block
                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'space-y-4 max-h-[500px] overflow-y-auto pr-2';
                
                block.items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'pb-4 border-b last:border-b-0 last:pb-0';
                    itemElement.id = `item-${item}`;
                    
                    itemElement.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold">${item}</span>
                            <button 
                                class="status-btn bg-red-500 text-white px-3 py-1 rounded" 
                                data-status="0" 
                                data-item="${item}"
                            >
                                Não iniciado
                            </button>
                        </div>
                        <div class="grid grid-cols-1 gap-2">
                            <textarea 
                                class="w-full p-2 border rounded text-sm" 
                                placeholder="Observações" 
                                data-item="${item}"
                                rows="2"
                            ></textarea>
                            <div class="grid grid-cols-2 gap-2">
                                <input 
                                    type="text" 
                                    class="w-full p-2 border rounded text-sm" 
                                    placeholder="Nome do morador" 
                                    data-item="${item}"
                                >
                                <div class="flex">
                                    <input 
                                        type="tel" 
                                        class="w-full p-2 border rounded text-sm rounded-r-none" 
                                        placeholder="Telefone" 
                                        data-item="${item}"
                                    >
                                    <a 
                                        href="#" 
                                        class="whatsapp-btn bg-gray-200 p-2 rounded-r flex items-center justify-center" 
                                        data-item="${item}"
                                        target="_blank"
                                    >
                                        <i class="fab fa-whatsapp whatsapp-icon"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    itemsContainer.appendChild(itemElement);
                });
                
                blockElement.appendChild(itemsContainer);
                appContainer.appendChild(blockElement);
            });
        }
        
        // Format current date and time
        function getFormattedTimestamp() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        }
        
        // Initialize the app
        function initApp() {
            generateBlocks();
            setupEventListeners();
            loadData();
            
            // Update status counts periodically
            setInterval(updateStatusCounts, 1000);
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Lock button
            document.getElementById('lockBtn').addEventListener('click', toggleLock);
            
            // Clear button
            document.getElementById('clearBtn').addEventListener('click', showClearConfirmation);
            document.getElementById('cancelClear').addEventListener('click', hideClearConfirmation);
            document.getElementById('confirmClear').addEventListener('click', clearAllData);
            
            // Status buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('status-btn')) {
                    if (!isLocked) {
                        cycleStatus(e.target);
                    }
                }
            });
            
            // Input fields
            document.addEventListener('input', function(e) {
                if (e.target.matches('input, textarea') && !isLocked) {
                    saveData();
                }
            });
        }
        
        // Show clear confirmation modal
        function showClearConfirmation() {
            document.getElementById('confirmModal').style.display = 'flex';
        }
        
        // Hide clear confirmation modal
        function hideClearConfirmation() {
            document.getElementById('confirmModal').style.display = 'none';
        }
        
        // Clear all data
        function clearAllData() {
            // Reset all status buttons to "Não iniciado" (red)
            const statusButtons = document.querySelectorAll('.status-btn');
            statusButtons.forEach(button => {
                button.dataset.status = '0';
                button.textContent = 'Não iniciado';
                button.className = 'status-btn bg-red-500 text-white px-3 py-1 rounded';
            });
            
            // Clear all text fields
            const textInputs = document.querySelectorAll('input[type="text"], input[type="tel"], textarea');
            textInputs.forEach(input => {
                input.value = '';
            });
            
            // Update WhatsApp links
            updateWhatsAppLinks();
            
            // Save empty data to Firebase
            database.ref('reforma-fachada').set({})
                .then(() => {
                    console.log('All data cleared successfully');
                    hideClearConfirmation();
                })
                .catch(error => console.error('Error clearing data:', error));
        }
        
        // Cycle through statuses
        function cycleStatus(button) {
            const currentStatus = parseInt(button.dataset.status);
            const nextStatus = (currentStatus + 1) % 3;
            
            button.dataset.status = nextStatus;
            
            switch(nextStatus) {
                case 0:
                    button.textContent = 'Não iniciado';
                    button.className = 'status-btn bg-red-500 text-white px-3 py-1 rounded';
                    break;
                case 1:
                    button.textContent = 'Em andamento';
                    button.className = 'status-btn bg-yellow-500 text-white px-3 py-1 rounded';
                    break;
                case 2:
                    button.textContent = 'Finalizado';
                    button.className = 'status-btn bg-green-500 text-white px-3 py-1 rounded';
                    break;
            }
            
            saveData();
            updateStatusCounts();
        }
        
        // Toggle lock
        function toggleLock() {
            isLocked = !isLocked;
            const lockBtn = document.getElementById('lockBtn');
            const timestamp = getFormattedTimestamp();
            
            if (isLocked) {
                lockBtn.innerHTML = '<i class="fas fa-lock mr-2"></i> Desbloquear';
                document.getElementById('appContainer').classList.add('locked');
                document.getElementById('lockTimestamp').textContent = `Bloqueado em: ${timestamp}`;
            } else {
                lockBtn.innerHTML = '<i class="fas fa-lock-open mr-2"></i> Bloquear';
                document.getElementById('appContainer').classList.remove('locked');
                document.getElementById('lockTimestamp').textContent = `Desbloqueado em: ${timestamp}`;
            }
            
            // Save lock state to Firebase
            saveData();
        }
        
        // Update status counts and progress bar
        function updateStatusCounts() {
            statusCounts = {
                notStarted: 0,
                inProgress: 0,
                completed: 0
            };
            
            const statusButtons = document.querySelectorAll('.status-btn');
            statusButtons.forEach(button => {
                const status = parseInt(button.dataset.status);
                
                switch(status) {
                    case 0:
                        statusCounts.notStarted++;
                        break;
                    case 1:
                        statusCounts.inProgress++;
                        break;
                    case 2:
                        statusCounts.completed++;
                        break;
                }
            });
            
            // Update global counts
            document.getElementById('notStartedCount').textContent = statusCounts.notStarted;
            document.getElementById('inProgressCount').textContent = statusCounts.inProgress;
            document.getElementById('completedCount').textContent = statusCounts.completed;
            
            // Calculate and update progress
            const totalItems = statusButtons.length;
            const completedPercentage = totalItems > 0 ? Math.round((statusCounts.completed / totalItems) * 100) : 0;
            
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressBar.style.width = `${completedPercentage}%`;
            progressText.textContent = `${completedPercentage}%`;
            
            // Update block-specific counts
            blocks.forEach(block => {
                const blockStatus = {
                    notStarted: 0,
                    inProgress: 0,
                    completed: 0
                };
                
                block.items.forEach(item => {
                    const button = document.querySelector(`.status-btn[data-item="${item}"]`);
                    if (button) {
                        const status = parseInt(button.dataset.status);
                        
                        switch(status) {
                            case 0:
                                blockStatus.notStarted++;
                                break;
                            case 1:
                                blockStatus.inProgress++;
                                break;
                            case 2:
                                blockStatus.completed++;
                                break;
                        }
                    }
                });
                
                const blockStatusElement = document.getElementById(`status-${block.name.replace(' ', '-')}`);
                if (blockStatusElement) {
                    blockStatusElement.innerHTML = `
                        <span class="status-badges bg-red-500 text-white">${blockStatus.notStarted}</span>
                        <span class="status-badges bg-yellow-500 text-white">${blockStatus.inProgress}</span>
                        <span class="status-badges bg-green-500 text-white">${blockStatus.completed}</span>
                    `;
                }
            });
            
            // Update WhatsApp links
            updateWhatsAppLinks();
        }
        
        // Update WhatsApp links
        function updateWhatsAppLinks() {
            const whatsappBtns = document.querySelectorAll('.whatsapp-btn');
            whatsappBtns.forEach(btn => {
                const item = btn.dataset.item;
                const phoneInput = document.querySelector(`input[type="tel"][data-item="${item}"]`);
                
                if (phoneInput && phoneInput.value) {
                    const phone = phoneInput.value.replace(/\D/g, '');
                    if (phone.length >= 10) {
                        btn.href = `https://wa.me/55${phone}`;
                    }
                }
            });
        }
        
        // Save data to Firebase
        function saveData() {
            const data = {};
            
            blocks.forEach(block => {
                block.items.forEach(item => {
                    const itemElement = document.getElementById(`item-${item}`);
                    if (itemElement) {
                        const statusButton = itemElement.querySelector('.status-btn');
                        const observations = itemElement.querySelector('textarea');
                        const residentName = itemElement.querySelector('input[type="text"]');
                        const phone = itemElement.querySelector('input[type="tel"]');
                        
                        data[item] = {
                            status: statusButton.dataset.status,
                            observations: observations.value,
                            residentName: residentName.value,
                            phone: phone.value
                        };
                    }
                });
            });
            
            // Add lock state and timestamp to data
            data['_system'] = {
                isLocked: isLocked,
                lastLockTimestamp: document.getElementById('lockTimestamp').textContent
            };
            
            database.ref('reforma-fachada').set(data)
                .then(() => console.log('Data saved successfully'))
                .catch(error => console.error('Error saving data:', error));
        }
        
        // Load data from Firebase
        function loadData() {
            database.ref('reforma-fachada').once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    if (data) {
                        Object.keys(data).forEach(item => {
                            // Skip system data
                            if (item === '_system') {
                                isLocked = data[item].isLocked || false;
                                const lockBtn = document.getElementById('lockBtn');
                                
                                if (isLocked) {
                                    lockBtn.innerHTML = '<i class="fas fa-lock mr-2"></i> Desbloquear';
                                    document.getElementById('appContainer').classList.add('locked');
                                } else {
                                    lockBtn.innerHTML = '<i class="fas fa-lock-open mr-2"></i> Bloquear';
                                    document.getElementById('appContainer').classList.remove('locked');
                                }
                                
                                if (data[item].lastLockTimestamp) {
                                    document.getElementById('lockTimestamp').textContent = data[item].lastLockTimestamp;
                                }
                                return;
                            }
                            
                            const itemData = data[item];
                            const itemElement = document.getElementById(`item-${item}`);
                            
                            if (itemElement) {
                                // Update status button
                                const statusButton = itemElement.querySelector('.status-btn');
                                if (statusButton) {
                                    statusButton.dataset.status = itemData.status || '0';
                                    
                                    switch(itemData.status) {
                                        case '0':
                                            statusButton.textContent = 'Não iniciado';
                                            statusButton.className = 'status-btn bg-red-500 text-white px-3 py-1 rounded';
                                            break;
                                        case '1':
                                            statusButton.textContent = 'Em andamento';
                                            statusButton.className = 'status-btn bg-yellow-500 text-white px-3 py-1 rounded';
                                            break;
                                        case '2':
                                            statusButton.textContent = 'Finalizado';
                                            statusButton.className = 'status-btn bg-green-500 text-white px-3 py-1 rounded';
                                            break;
                                    }
                                }
                                
                                // Update other fields
                                const observations = itemElement.querySelector('textarea');
                                const residentName = itemElement.querySelector('input[type="text"]');
                                const phone = itemElement.querySelector('input[type="tel"]');
                                
                                if (observations) observations.value = itemData.observations || '';
                                if (residentName) residentName.value = itemData.residentName || '';
                                if (phone) phone.value = itemData.phone || '';
                            }
                        });
                        
                        updateStatusCounts();
                    }
                })
                .catch(error => console.error('Error loading data:', error));
        }
        
        // Listen for real-time updates
        database.ref('reforma-fachada').on('value', snapshot => {
            const data = snapshot.val();
            if (data) {
                Object.keys(data).forEach(item => {
                    // Skip system data
                    if (item === '_system') {
                        isLocked = data[item].isLocked || false;
                        const lockBtn = document.getElementById('lockBtn');
                        
                        if (isLocked) {
                            lockBtn.innerHTML = '<i class="fas fa-lock mr-2"></i> Desbloquear';
                            document.getElementById('appContainer').classList.add('locked');
                        } else {
                            lockBtn.innerHTML = '<i class="fas fa-lock-open mr-2"></i> Bloquear';
                            document.getElementById('appContainer').classList.remove('locked');
                        }
                        
                        if (data[item].lastLockTimestamp) {
                            document.getElementById('lockTimestamp').textContent = data[item].lastLockTimestamp;
                        }
                        return;
                    }
                    
                    const itemData = data[item];
                    const itemElement = document.getElementById(`item-${item}`);
                    
                    if (itemElement) {
                        // Update status button
                        const statusButton = itemElement.querySelector('.status-btn');
                        if (statusButton && statusButton.dataset.status !== itemData.status) {
                            statusButton.dataset.status = nextStatus;
                            
                            switch(itemData.status) {
                                case '0':
                                    statusButton.textContent = 'Não iniciado';
                                    statusButton.className = 'status-btn bg-red-500 text-white px-3 py-1 rounded';
                                    break;
                                case '1':
                                    statusButton.textContent = 'Em andamento';
                                    statusButton.className = 'status-btn bg-yellow-500 text-white px-3 py-1 rounded';
                                    break;
                                case '2':
                                    statusButton.textContent = 'Finalizado';
                                    statusButton.className = 'status-btn bg-green-500 text-white px-3 py-1 rounded';
                                    break;
                            }
                        }
                        
                        // Update other fields
                        const observations = itemElement.querySelector('textarea');
                        const residentName = itemElement.querySelector('input[type="text"]');
                        const phone = itemElement.querySelector('input[type="tel"]');
                        
                        if (observations && observations.value !== itemData.observations) {
                            observations.value = itemData.observations || '';
                        }
                        if (residentName && residentName.value !== itemData.residentName) {
                            residentName.value = itemData.residentName || '';
                        }
                        if (phone && phone.value !== itemData.phone) {
                            phone.value = itemData.phone || '';
                        }
                    }
                });
                
                updateStatusCounts();
            }
        });
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</html>
